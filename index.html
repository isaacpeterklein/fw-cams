<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fort Worth Traffic Cams</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0d0d0d;
      color: #ccc;
      font-family: system-ui, sans-serif;
      padding: 1rem;
    }

    h1 {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #333;
      margin-bottom: 1rem;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(480px, 1fr));
      gap: 1rem;
    }

    .cam-card {
      background: #111;
      border: 1px solid #1c1c1c;
      border-radius: 3px;
      overflow: hidden;
    }

    /* image + overlay wrapper */
    .cam-image-wrap {
      position: relative;
      aspect-ratio: 16/9;
      background: #000;
      overflow: hidden;
    }

    .cam-card img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.4s ease;
    }

    .cam-card img.stale { opacity: 0.3; }

    /* loading overlay */
    .cam-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      opacity: 1;
      transition: opacity 0.8s ease;
      pointer-events: none;
    }

    .cam-card.loaded .cam-overlay { opacity: 0; }

    /* sweeping scan line */
    .cam-overlay::after {
      content: '';
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff41 30%, #00ff41 70%, transparent);
      opacity: 0.45;
      animation: scan 2.4s linear infinite;
    }

    @keyframes scan {
      from { top: -2px; }
      to   { top: 100%; }
    }

    /* corner brackets */
    .cam-corner {
      position: absolute;
      width: 16px;
      height: 16px;
    }
    .cam-corner.tl { top: 10px; left: 10px;  border-top:    1.5px solid #00ff41; border-left:  1.5px solid #00ff41; }
    .cam-corner.tr { top: 10px; right: 10px; border-top:    1.5px solid #00ff41; border-right: 1.5px solid #00ff41; }
    .cam-corner.bl { bottom: 10px; left: 10px;  border-bottom: 1.5px solid #00ff41; border-left:  1.5px solid #00ff41; }
    .cam-corner.br { bottom: 10px; right: 10px; border-bottom: 1.5px solid #00ff41; border-right: 1.5px solid #00ff41; }

    /* acquiring text */
    .cam-overlay-text {
      font-family: 'Courier New', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.25em;
      color: #00ff41;
      opacity: 0.75;
      text-transform: uppercase;
    }

    .cam-overlay-text::after {
      content: '';
      animation: ellipsis 1.2s steps(1) infinite;
    }

    @keyframes ellipsis {
      0%  { content: '';    }
      25% { content: '.';   }
      50% { content: '..';  }
      75% { content: '...'; }
    }

    .cam-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.45rem 0.75rem;
      border-top: 1px solid #181818;
    }

    .cam-label {
      font-size: 0.72rem;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #666;
    }

    .cam-status {
      font-family: 'Courier New', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.04em;
      color: #2a2a2a;
    }

    .cam-status.ok  { color: #1e5c1e; }
    .cam-status.err { color: #5c1e1e; }
  </style>
</head>
<body>
  <h1>Fort Worth Traffic Cams</h1>
  <div id="grid"></div>

  <script>
    const REFRESH_MS = 10000;

    // card registry: id -> { img, status, lastOk }
    const cards = {};
    const STALE_MS = 30000;

    function buildCard(cam) {
      const card = document.createElement('div');
      card.className = 'cam-card';
      card.id = `cam-${CSS.escape(cam.id)}`;

      const wrap = document.createElement('div');
      wrap.className = 'cam-image-wrap';

      const img = document.createElement('img');
      img.alt = cam.label;

      const overlay = document.createElement('div');
      overlay.className = 'cam-overlay';
      ['tl','tr','bl','br'].forEach(pos => {
        const c = document.createElement('div');
        c.className = `cam-corner ${pos}`;
        overlay.appendChild(c);
      });
      const overlayText = document.createElement('span');
      overlayText.className = 'cam-overlay-text';
      overlayText.textContent = 'Acquiring feed';
      overlay.appendChild(overlayText);

      wrap.appendChild(img);
      wrap.appendChild(overlay);

      const footer = document.createElement('div');
      footer.className = 'cam-footer';

      const label = document.createElement('span');
      label.className = 'cam-label';
      label.textContent = cam.label;

      const status = document.createElement('span');
      status.className = 'cam-status';

      footer.appendChild(label);
      footer.appendChild(status);
      card.appendChild(wrap);
      card.appendChild(footer);

      return { card, img, status, lastOk: null };
    }

    function formatAge(ms) {
      const s = Math.floor(ms / 1000);
      if (s < 60) return `${s}s ago`;
      return `${Math.floor(s / 60)}m ${s % 60}s ago`;
    }

    function applySnapshot({ id, snippet, error }, entry) {
      const { img, status } = entry;
      if (error || !snippet) {
        status.textContent = 'error';
        status.className = 'cam-status err';
        return;
      }
      const next = new Image();
      next.onload = () => {
        img.src = next.src;
        img.closest('.cam-card').classList.add('loaded');
      };
      next.src = `data:image/jpeg;base64,${snippet}`;
      entry.lastOk = Date.now();
      status.className = 'cam-status ok';
    }

    // 1s ticker: updates "Xs ago" text and stale class on all cards
    setInterval(() => {
      const now = Date.now();
      for (const entry of Object.values(cards)) {
        if (entry.lastOk === null) continue;
        const age = now - entry.lastOk;
        entry.status.textContent = formatAge(age);
        entry.img.classList.toggle('stale', age > STALE_MS);
      }
    }, 1000);

    const STAGGER_MS = 150;
    const RETRY_MS   = 3000;

    async function refreshAll() {
      let nextDelay = REFRESH_MS;
      try {
        const res = await fetch('/api/snapshots');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const snapshots = await res.json();
        snapshots.forEach((snap, i) => {
          if (!cards[snap.id]) return;
          setTimeout(() => applySnapshot(snap, cards[snap.id]), i * STAGGER_MS);
        });
      } catch (e) {
        for (const entry of Object.values(cards)) {
          entry.status.textContent = 'error';
          entry.status.className = 'cam-status err';
        }
        nextDelay = RETRY_MS;
      }
      setTimeout(refreshAll, nextDelay);
    }

    async function init() {
      try {
        const res = await fetch('/api/cameras');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const cameras = await res.json();
        const grid = document.getElementById('grid');

        for (const cam of cameras) {
          const { card, img, status, lastOk } = buildCard(cam);
          cards[cam.id] = { img, status, lastOk };
          grid.appendChild(card);
        }

        refreshAll();
      } catch (e) {
        document.getElementById('grid').textContent = 'Failed to load cameras.';
      }
    }

    init();
  </script>
</body>
</html>
